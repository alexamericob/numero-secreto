name: CI - Code Quality (JavaScript) + SonarCloud

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
      # 1) Faz checkout do repositório para o runner (pega o código do GitHub)
      - name: Checkout do código
        uses: actions/checkout@v4

      # 2) Prepara o Node.js para executar npm/npx (ambiente de build/lint)
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3) (Opcional) Garante um package.json e instala ESLint + preset @eslint/js
      #    Observação: ideal mesmo é você versionar um package.json com eslint no repo,
      #    mas aqui mantemos seu modelo atual (tudo gerado no CI).
      - name: Preparar ambiente de lint (ESLint)
        run: |
          npm init -y
          npm install --save-dev eslint @eslint/js

      # 4) Cria o arquivo de configuração do ESLint (Flat Config) já corrigido:
      #    - Config browser para os arquivos da aplicação (alert/prompt/console/etc.)
      #    - Config Node apenas para eslint.config.js (require/module)
      - name: Criar configuração do ESLint (Flat Config) - corrigida (browser + node)
        run: |
          cat > eslint.config.js << 'EOF'
          const js = require("@eslint/js");

          module.exports = [
            // ===============================
            // Configuração padrão recomendada
            // ===============================
            js.configs.recommended,

            // =========================================
            // Configuração para arquivos da aplicação
            // (browser: alert, prompt, console, etc.)
            // =========================================
            {
              files: ["**/*.js"],
              languageOptions: {
                ecmaVersion: "latest",
                sourceType: "script",
                globals: {
                  window: "readonly",
                  document: "readonly",
                  alert: "readonly",
                  prompt: "readonly",
                  console: "readonly"
                }
              },
              rules: {
                "no-unused-vars": "warn",
                "no-undef": "error"
              }
            },

            // =========================================
            // Configuração específica para arquivos Node
            // (eslint.config.js)
            // =========================================
            {
              files: ["eslint.config.js"],
              languageOptions: {
                sourceType: "commonjs",
                globals: {
                  require: "readonly",
                  module: "readonly"
                }
              }
            }
          ];
          EOF

      # 5) Roda o ESLint no repositório
      - name: Rodar ESLint nos arquivos JavaScript
        run: |
          npx eslint "**/*.js"

      # 6) Executa o scan do SonarCloud (precisa do SONAR_TOKEN nos Secrets do repo)
      #    Secrets esperados:
      #    - SONAR_TOKEN: token gerado no SonarCloud
      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=alexamericob
            -Dsonar.projectKey=alexamericob_numero-secreto
            -Dsonar.sources=.

      # 7) (Recomendado) Aguarda o Quality Gate e falha a pipeline se não passar
      #    Isso garante “quality gate obrigatório” (pipeline para se falhar no Sonar).
      - name: SonarCloud Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          scanMetadataReportFile: .scannerwork/report-task.txt