name: CI - Code Quality (JavaScript + SonarCloud)

on:
  # Executa em push na branch main
  push:
    branches: ["main"]

  # Executa em Pull Requests para main
  pull_request:
    branches: ["main"]

  # Permite executar manualmente via GitHub Actions
  workflow_dispatch:

jobs:
  quality:
    name: Quality Pipeline
    runs-on: ubuntu-latest

    steps:
      # =========================
      # 1Ô∏è‚É£ Checkout do c√≥digo
      # =========================
      # Faz o clone do reposit√≥rio no runner do GitHub
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      # =========================
      # 2Ô∏è‚É£ Configurar  Node.js
      # =========================
      # Define vers√£o do Node para garantir consist√™ncia
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # =========================
      # 3Ô∏è‚É£ Preparar ambiente de lint
      # =========================
      # Inicializa package.json (caso n√£o exista)
      # Instala ESLint com suporte ao Flat Config
      - name: Preparar ambiente de lint (ESLint)
        run: |
          npm init -y
          npm install --save-dev eslint @eslint/js

      # =========================
      # 4Ô∏è‚É£ Criar configura√ß√£o ESLint (Flat Config)
      # =========================
      # Configura:
      # - Ambiente browser (alert, prompt, console)
      # - Regras recomendadas
      - name: Criar configura√ß√£o do ESLint (Flat Config)
        run: |
          cat > eslint.config.js << 'EOF'
          const js = require("@eslint/js");

          module.exports = [
            js.configs.recommended,
            {
              languageOptions: {
                ecmaVersion: "latest",
                sourceType: "script",
                globals: {
                  alert: "readonly",
                  prompt: "readonly",
                  console: "readonly"
                }
              },
              rules: {
                "no-unused-vars": "warn",
                "no-undef": "error"
              }
            }
          ];
          EOF

      # =========================
      # 5Ô∏è‚É£ Rodar ESLint
      # =========================
      # Se houver erros, o job falha aqui
      - name: Rodar ESLint nos arquivos JavaScript
        run: |
          npx eslint "**/*.js"

      # =========================
      # 6Ô∏è‚É£ SonarCloud Scan
      # =========================
      # Envia an√°lise de c√≥digo para o SonarCloud
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-scan-action@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=alexamericob
            -Dsonar.projectKey=alexamericob_numero-secreto
            -Dsonar.sources=.

      # =========================
      # 7Ô∏è‚É£ Quality Gate (üî• PASSO CR√çTICO üî•)
      # =========================
      # Aguarda o resultado do Quality Gate
      # FALHA a pipeline se o Sonar reprovar
      - name: SonarCloud Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
