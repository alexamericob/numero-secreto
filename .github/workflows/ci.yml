# Nome do workflow que aparecerá na aba "Actions" do GitHub
name: CI - Code Quality (JavaScript)

# Eventos que disparam a execução do pipeline
on:
  # Executa quando houver push para a branch main
  push:
    branches: ["main"]

  # Executa quando houver Pull Request direcionado para a branch main
  pull_request:
    branches: ["main"]

  # Permite executar o pipeline manualmente pelo botão "Run workflow"
  workflow_dispatch:

jobs:
  # Nome do job (pode existir mais de um job em um workflow)
  quality:
    # Define o ambiente onde o job será executado
    # ubuntu-latest é o padrão mais usado em pipelines CI
    runs-on: ubuntu-latest

    steps:
      # Step 1 - Faz o checkout do código do repositório
      # Sem isso, o runner não teria acesso aos arquivos do projeto
      - name: Checkout do código
        uses: actions/checkout@v4

      # Step 2 - Configura o ambiente Node.js
      # Necessário para executar npm, npx e ferramentas JavaScript
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          # Versão do Node.js usada no pipeline
          node-version: "20"

      # Step 3 - Prepara o ambiente de lint
      # Inicializa um package.json (caso o projeto não tenha)
      # e instala o ESLint e as regras base do JavaScript
      - name: Preparar ambiente de lint (ESLint)
        run: |
          npm init -y
          npm install --save-dev eslint @eslint/js

      # Step 4 - Cria o arquivo de configuração do ESLint
      # Utiliza o novo padrão "Flat Config" (eslint.config.js),
      # obrigatório a partir do ESLint v9+
      - name: Criar configuração do ESLint (Flat Config)
        run: |
          cat > eslint.config.js << 'EOF'
          const js = require("@eslint/js");

          module.exports = [
            # Regras recomendadas padrão do ESLint
            js.configs.recommended,
            {
              # Configurações da linguagem JavaScript
              languageOptions: {
                # Usa a versão mais recente do ECMAScript
                ecmaVersion: "latest",

                # Define que o código roda no browser (scripts)
                sourceType: "script"
              },

              # Regras customizadas de qualidade de código
              rules: {
                # Variáveis não utilizadas geram warning, mas não quebram o build
                "no-unused-vars": "warn",

                # Variáveis não declaradas quebram o pipeline (erro)
                "no-undef": "error"
              }
            }
          ];
          EOF

      # Step 5 - Executa o ESLint em todos os arquivos JavaScript do projeto
      # Se houver erro (ex: no-undef), o pipeline falha automaticamente
      - name: Rodar ESLint nos arquivos JavaScript
        run: |
          npx eslint "**/*.js"
